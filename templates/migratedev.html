{% extends 'base.html' %}

{% block title %}
Migration - vNet Migration Tool
{% endblock %}

{% block content %}
<div class="container">
    <h2>vNet Migration</h2>
    <form id="migration-form">
        <div class="mb-3">
            <label for="subscription" class="form-label">Select Subscription</label>
            <select class="form-select" id="subscription" required>
                <option value="">Choose a subscription</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="vnet" class="form-label">Select vNets</label>
            <select class="form-select" id="vnet" multiple required>
                <option value="">Choose vNets</option>
            </select>
        </div>

        <div class="mb-3">
            <label for="vwan" class="form-label">Select Virtual WAN</label>
            <select class="form-select" id="vwan" required>
                <option value="">Choose a Virtual WAN</option>
                <!-- vWAN options will be added dynamically -->
            </select>
        </div>

        <div class="mb-3">
            <label for="vwanhub" class="form-label">Select vWAN Hub</label>
            <select class="form-select" id="vhub" required>
                <option value="">Choose a vWAN Hub</option>
                <!-- vWAN Hub options will be added dynamically -->
            </select>
        </div>
        <button type="submit" class="btn btn-primary">Migrate</button>
    </form>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        // Fetch the available subscriptions
        fetch("/subscriptions")
            .then((response) => response.json())
            .then((subscriptions) => {
                const select = document.getElementById("subscription");
                subscriptions.forEach((sub) => {
                    const option = document.createElement("option");
                    option.value = sub.subscription_id;
                    option.textContent = sub.display_name;
                    select.appendChild(option);
                });
            })
            .catch((error) => console.error("Failed to fetch subscriptions:", error));

        // Update vNets dropdown when the subscription is changed
        document.getElementById("subscription").addEventListener("change", (event) => {
            const subscriptionId = event.target.value;
            if (subscriptionId) {
                updateVnets(subscriptionId);
                updateVirtualWans(subscriptionId);
            }
        });

        document.getElementById("vwan").addEventListener("change", (event) => {
            const vwanId = event.target.value;
            if (vwanId) {
                updateVwanHubs(vwanId);
            }
        });

        function updateVnets(subscriptionId) {
            fetch("/vnets", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ subscription_id: subscriptionId }),
            })
            .then((response) => response.json())
            .then((vnets) => {
                const select = document.getElementById("vnet");
                // Remove any existing options
                while (select.firstChild) {
                    select.removeChild(select.firstChild);
                }
                // Add new options
                vnets.forEach((vnet) => {
                    const option = document.createElement("option");
                    option.value = vnet.name;
                    option.textContent = vnet.name;
                    select.appendChild(option);
                });
            })
            .catch((error) => console.error("Failed to fetch vNets:", error));
        }

        function updateVirtualWans(subscriptionId) {
            fetch("/virtualwans", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ subscription_id: subscriptionId }),
            })
            .then((response) => response.json())
            .then((virtualwans) => {
                const select = document.getElementById("vwan");
                // Remove any existing options
                while (select.firstChild) {
                    select.removeChild(select.firstChild);
                }
                // Add new options
                virtualwans.forEach((vwan) => {
                    const option = document.createElement("option");
                    option.value = vwan.id;
                    option.textContent = vwan.name;
                    select.appendChild(option);
                });
            })
            .catch((error) => console.error("Failed to fetch Virtual WANs:", error));
        }

        function updateVwanHubs(vwanId) {
            fetch("/vwanhubs", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ vwan_id: vwanId }),
            })
            .then((response) => response.json())
            .then((vwanhubs) => {
                const select = document.getElementById("vhub");
                // Remove any existing options
                while (select.firstChild) {
                    select.removeChild(select.firstChild);
                }
                // Add new options
                vwanhubs.forEach((vhub) => {
                    const option = document.createElement("option");
                    option.value = vhub.id;
                    option.textContent = vhub.name;
                    select.appendChild(option);
                });
            })
            .catch((error) => console.error("Failed to fetch vWAN Hubs:", error));
        }



document.getElementById("vwan").addEventListener("change", (event) => {
    const vwanId = event.target.value;
    if (vwanId) {
        fetch("/vwanhubs", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({ vwan_id: vwanId }),
        })
        .then((response) => response.json())
        .then((vwanhubs) => {
            console.log("vWAN Hubs fetched:", vwanhubs);
            const select = document.getElementById("vhub");
            select.innerHTML = ""; // Clear existing options
            const defaultOption = document.createElement("option");
            defaultOption.value = "";
            defaultOption.textContent = "Choose a vWAN Hub";
            select.appendChild(defaultOption);
            vwanhubs.forEach((vhub) => {
                const option = document.createElement("option");
                option.value = vhub.id;
                option.textContent = vhub.name;
                select.appendChild(option);
            });
        })
        .catch((error) => console.error("Failed to fetch vWAN Hubs:", error));
    }
});

        // Handle form submission
        document.getElementById("migration-form").addEventListener("submit", (event) => {
            event.preventDefault();

            const subscriptionId = document.getElementById("subscription").value;
            const vnet = Array.from(document.getElementById("vnet").selectedOptions).map(option => option.value);
            const spkrg = document.getElementById("spkrg").value;
            const spkvnetname = document.getElementById("spkvnetname").value;
            const spkpeeringname = document.getElementById("spkpeeringname").value;
            const vwanrg = document.getElementById("vwanrg").value;
            const vhubname = document.getElementById("vhubname").value;

            fetch("/migrate", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    subscription_id: subscriptionId,
                    vnets: vnet,
                    spkrg: spkrg,
                    spkvnetname: spkvnetname,
                    spkpeeringname: spkpeeringname,
                    vwanrg: vwanrg,
                    vhubname: vhubname
                }),
            })
            .then((response) => response.json())
            .then((data) => {
                if (data.error) {
                    console.error("Failed to migrate:", data.error);
                } else {
                    console.log("Migration successful:", data.result);
                }
            })
            .catch((error) => console.error("Failed to send migration request:", error));
        });
    });


</script>
{% endblock %}