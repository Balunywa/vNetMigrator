{% extends "base.html" %}

{% block content %}
    <h1 class="mb-4">Azure Network Migration</h1>
    <div class="card">
        <div class="card-body">
            <form id="migration-form" class="mb-3" onsubmit="event.preventDefault(); migrate();">
                <div class="mb-3">
                    <label for="subscription" class="form-label">Subscription:</label>
                    <select class="form-select" id="subscription" name="subscription"></select>
                </div>
                <div class="mb-3">
                    <label for="vnet" class="form-label">VNet:</label>
                    <select class="form-select" id="vnet" name="vnet"></select>
                </div>
                <button type="submit" class="btn btn-primary">Migrate</button>
            </form>
        </div>
    </div>
    <div id="result" class="mt-3"></div>
    <div class="mt-5">
        <h2 class="mb-4">Migration Dashboard</h2>
        <table class="table">
            <thead>
                <tr>
                    <th scope="col">Resource Group</th>
                    <th scope="col">VNet Name</th>
                    <th scope="col">Status</th>
                    <th scope="col">Migration Date</th>
                </tr>
            </thead>
            <tbody id="migration-table">
                <!-- Table rows will be populated using JavaScript -->
            </tbody>
        </table>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        const subscriptionSelect = document.getElementById('subscription');
        const vnetSelect = document.getElementById('vnet');
        const migrationTable = document.getElementById('migration-table');

        async function fetchSubscriptions() {
            const response = await fetch('/subscriptions');
            const data = await response.json();
            if (data.success) {
                data.subscriptions.forEach(subscription => {
                    const option = document.createElement('option');
                    option.value = subscription.subscription_id;
                    option.textContent = subscription.display_name;
                    subscriptionSelect.appendChild(option);
                });
                fetchVpnVnets();
            }
        }

        async function fetchVpnVnets() {
            const subscriptionId = subscriptionSelect.value;
            const response = await fetch(`/vpn_vnets?subscription_id=${subscriptionId}`);
            const data = await response.json();
            if (data.success) {
                vnetSelect.innerHTML = '';
                data.vpn_vnets.forEach(vnet => {
                    const option = document.createElement('option');
                    option.value = vnet.name;
                    option.textContent = vnet.name;
                    vnetSelect.appendChild(option);
                });
            }
        }

        async function fetchMigrationDashboard() {
            // Implement the logic to fetch migration data and populate the table
        }

        async function migrate() {
            const formData = new FormData(document.getElementById('migration-form'));
            const response = await fetch('/migrate', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            if (result.success) {
                alert('VNet migration successful');
            } else {
                alert(`Error: ${result.message}`);
            }
        }

        subscriptionSelect.addEventListener('change', fetchVpnVnets);

        fetchSubscriptions();
        fetchMigrationDashboard();
    </script>
{% endblock %}


